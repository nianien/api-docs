# API Docs Portal

统一的 API 文档门户，基于 Docusaurus + Redocusaurus 构建。

## 架构说明

- **业务服务仓**：负责生成 `openapi-xxx.yaml`（对业务仓来说是产物）
- **api-docs 仓**：Docusaurus + Redocusaurus，将 YAML 文件渲染成 API 文档站
- **部署**：构建后的静态站点可部署到 GitHub Pages 或 Nginx

## 快速开始

### 本地开发

```bash
npm install
npm start
```

访问 http://localhost:3000/api-docs 查看文档首页

### 构建

```bash
npm run build
```

构建产物在 `build/` 目录

### 本地预览构建结果

```bash
npm run serve
```

## 添加新服务

### 1. 在业务服务仓中

确保服务已集成 springdoc，暴露 `/v3/api-docs.yaml` 端点。

使用提供的脚本导出 OpenAPI YAML：

```bash
# 在业务服务仓中
./scripts/export-openapi.sh
```

这会生成 `openapi-service-a.yaml` 文件。

### 2. 同步到 api-docs 仓

将生成的 YAML 文件复制到 `static/openapi/` 目录：

```bash
cp openapi-service-a.yaml ../api-docs/static/openapi/service-b.yaml
```

### 3. 自动生成配置（无需手动配置）

系统会自动扫描 `static/openapi/` 目录，生成 API 路由和导航菜单：

- **API Specs**：`docusaurus.config.js` 中的 `scanRedocSpecs()` 函数动态扫描 `static/openapi/` 目录
- **Navbar 菜单**：`docusaurus.config.js` 中的 `buildApiNavItems()` 自动生成分组下拉菜单
- **文档 Sidebar**：`sidebars.js` 使用 `autogenerated` 模式，自动生成文档目录结构

**目录结构决定路由**：
- `static/openapi/trading/ba_position.yaml` → `/api/trading/ba_position`
- `static/openapi/market-data/price_history.yaml` → `/api/market-data/price_history`

### 4. 重新构建和部署

```bash
npm run build
```

## 部署

### GitHub Pages

1. 确保 `.github/workflows/deploy.yml` 已配置
2. 在 GitHub 仓库设置中启用 GitHub Pages，选择 "GitHub Actions" 作为源
3. 修改 `docusaurus.config.js` 中的 `url`、`baseUrl`、`organizationName`、`projectName`
4. Push 到 main 分支，GitHub Actions 会自动构建并部署

### Nginx

1. 构建项目：`npm run build`
2. 将 `build/` 目录内容复制到服务器，例如 `/var/www/api-docs`
3. 配置 Nginx：

```nginx
server {
    listen 80;
    server_name api-docs.your-company.com;

    root /var/www/api-docs;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 目录结构

```
api-docs/
├── static/
│   └── openapi/              # OpenAPI YAML 文件存放目录（按 domain 分组）
│       ├── trading/           # Trading 域 API
│       │   ├── ba_position.yaml
│       │   └── ib_portal_api.yaml
│       └── market-data/       # Market Data 域 API
│           ├── market_data.yaml
│           └── price_history.yaml
├── docs/                      # 文档内容（自动生成 Sidebar）
│   ├── overview/             # 总览文档
│   ├── products/             # 产品文档
│   ├── trading/              # Trading 文档
│   ├── market-data/          # Market Data 文档
│   ├── integration/          # 集成文档
│   └── legal/                # 法务文档
├── scripts/
│   └── export-openapi.sh         # 业务服务导出脚本示例
├── .github/
│   └── workflows/
│       └── deploy.yml        # GitHub Actions 部署配置
├── docusaurus.config.js     # Docusaurus 配置（动态扫描 OpenAPI 文件）
├── sidebars.js              # Sidebar 配置（autogenerated 模式）
└── package.json
```

## 自动化流程

1. **添加 OpenAPI 文件**：将 YAML 文件放到 `static/openapi/<domain>/` 目录
2. **动态扫描配置**：运行 `npm start` 或 `npm run build` 时，`docusaurus.config.js` 自动扫描文件
3. **自动生成路由**：根据文件路径自动生成 `/api/<domain>/<filename>` 路由
4. **自动生成菜单**：Navbar 的 "API Reference" 下拉菜单自动按 domain 分组
5. **自动生成 Sidebar**：文档目录结构自动从 `docs/` 目录生成
6. **自动生成 Footer**：Footer 链接自动从文档结构生成

## 注意事项

- OpenAPI YAML 文件应放在 `static/openapi/<domain>/` 目录（按域分组）
- 文件名（不含扩展名）将作为路由和菜单标签
- 目录结构决定 API 分组和路由路径
- 修改文件后需要重新构建才能生效
